<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invest Codebase Viz</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, sans-serif; background: #0c0c0c; color: #e5e5e5; height: 100vh; overflow: hidden; }
    .topbar { border-bottom: 1px solid #2a2a2a; background: #161616; padding: 10px 16px; display: flex; align-items: center; gap: 20px; }
    .brand { font-size: 13px; font-weight: 700; }
    .brand small { color: #777; font-weight: 500; margin-left: 10px; }
    .tabs { display: flex; gap: 8px; }
    .tab-btn { font-size: 11px; text-transform: uppercase; letter-spacing: .8px; padding: 8px 10px; border: 1px solid #2a2a2a; border-radius: 7px; background: #161616; color: #888; cursor: pointer; }
    .tab-btn.active { color: #e5e5e5; border-color: #60a5fa; background: #131c2e; }

    .tab-panel { display: none; height: calc(100vh - 52px); }
    .tab-panel.active { display: block; }
    .scroll { height: 100%; overflow: auto; padding: 20px; }
    .scroll::-webkit-scrollbar { width: 6px; height: 6px; }
    .scroll::-webkit-scrollbar-thumb { background: #2a2a2a; border-radius: 4px; }

    .section { margin-bottom: 28px; }
    .section h3 { margin: 0 0 12px 0; font-size: 11px; letter-spacing: 1px; text-transform: uppercase; color: #555; }
    .card { background: #161616; border: 1px solid #2a2a2a; border-radius: 10px; padding: 16px; }
    .cards { display: grid; gap: 12px; }
    .cards.metrics { grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); }
    .metric-num { font-size: 22px; font-weight: 800; line-height: 1; }
    .metric-label { font-size: 11px; color: #666; margin-top: 5px; }

    .badge-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .badge { font-size: 11px; border-radius: 20px; padding: 5px 10px; border: 1px solid; background: #1a1a1a; }
    .b-client { color: #60a5fa; border-color: #1e40af; background: #131c2e; }
    .b-core { color: #4ade80; border-color: #166534; background: #132013; }
    .b-ext { color: #a78bfa; border-color: #5b21b6; background: #1c1528; }
    .b-api { color: #fbbf24; border-color: #92400e; background: #1f1a0f; }
    .b-data { color: #f472b6; border-color: #9d174d; background: #1f1320; }
    .b-infra { color: #94a3b8; border-color: #475569; background: #181818; }

    table { width: 100%; border-collapse: collapse; }
    th { font-size: 10px; text-transform: uppercase; letter-spacing: .8px; color: #555; text-align: left; border-bottom: 1px solid #2a2a2a; padding: 8px; }
    td { border-bottom: 1px solid #1a1a1a; padding: 8px; font-size: 12px; color: #999; vertical-align: top; }
    tr:hover td { background: #181818; }
    .risk-low { color: #4ade80; }
    .risk-med { color: #fbbf24; }
    .risk-high { color: #ef4444; }

    .dot-list { margin: 0; padding: 0; list-style: none; }
    .dot-list li { color: #999; font-size: 12px; line-height: 1.5; margin: 7px 0; padding-left: 14px; position: relative; }
    .dot-list li::before { content: ''; width: 6px; height: 6px; background: #60a5fa; border-radius: 50%; position: absolute; left: 0; top: 6px; }

    .warn { border: 1px solid #92400e66; background: #1a1209; color: #d3b07a; font-size: 12px; border-radius: 8px; padding: 10px; margin-bottom: 8px; }

    .arch-layout { display: grid; grid-template-columns: 260px 1fr; height: 100%; }
    .sidebar { background: #161616; border-right: 1px solid #2a2a2a; overflow: auto; }
    .side-sec { border-bottom: 1px solid #2a2a2a; padding: 12px; }
    .side-sec h4 { margin: 0 0 10px 0; font-size: 10px; text-transform: uppercase; letter-spacing: .8px; color: #555; }
    .side-row { display: flex; align-items: center; gap: 8px; margin: 6px 0; font-size: 11px; color: #888; }
    .side-row input { accent-color: #2563eb; }
    .search { width: 100%; border: 1px solid #2a2a2a; border-radius: 6px; padding: 7px 9px; background: #0c0c0c; color: #ddd; font-size: 11px; }
    .preset-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .preset { font-size: 10px; border: 1px solid #2a2a2a; border-radius: 6px; padding: 6px; background: #1a1a1a; color: #888; cursor: pointer; }
    .preset.active { border-color: #60a5fa; color: #cfe6ff; background: #131c2e; }

    .canvas-wrap { position: relative; height: calc(100% - 140px); }
    .prompt { height: 140px; border-top: 1px solid #2a2a2a; background: #161616; display: flex; flex-direction: column; }
    .prompt-head { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid #2a2a2a; }
    .prompt-head span { font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: .8px; }
    .copy { border: 1px solid #2a2a2a; background: #1a1a1a; color: #999; border-radius: 6px; font-size: 10px; padding: 3px 8px; cursor: pointer; }
    .prompt-body { padding: 10px 12px; font-family: SFMono-Regular, Menlo, monospace; font-size: 11px; color: #777; overflow: auto; white-space: pre-wrap; }

    .overlay-controls { position: absolute; left: 12px; bottom: 12px; z-index: 2; display: flex; align-items: center; background: #161616; border: 1px solid #2a2a2a; border-radius: 7px; overflow: hidden; }
    .overlay-controls button { background: #161616; color: #888; border: none; padding: 6px 9px; cursor: pointer; }
    .overlay-controls button:hover { background: #202020; color: #ddd; }
    .overlay-controls .zoom { font-size: 10px; color: #666; padding: 0 8px; }

    .legend { position: absolute; right: 12px; bottom: 12px; z-index: 2; background: #161616; border: 1px solid #2a2a2a; border-radius: 8px; padding: 8px; }
    .legend h5 { margin: 0 0 7px 0; font-size: 9px; color: #555; text-transform: uppercase; letter-spacing: .7px; }
    .legend .row { display: flex; align-items: center; gap: 7px; margin: 4px 0; font-size: 10px; color: #777; }
    .legend .line { width: 14px; height: 0; border-top: 2px solid #666; }

    .dep-graph { height: 450px; background: #111; border: 1px solid #2a2a2a; border-radius: 10px; position: relative; overflow: hidden; }

    .flow-section { background:#161616; border:1px solid #2a2a2a; border-radius:10px; padding:20px; margin-bottom:16px }
    .flow-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px; }
    .flow-title { font-size: 14px; font-weight: 700; }
    .flow-meta { font-size: 11px; color: #666; font-family: SFMono-Regular, Menlo, monospace; }
    .flow-gherkin { display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:16px; padding:12px; background:#0c0c0c; border-radius:6px; border:1px solid #1a1a1a }
    .gherkin-label { padding:4px 10px; font-size:10px; font-weight:600; border-radius:4px; text-transform:uppercase; letter-spacing:1px }
    .gherkin-label.gherkin-given { background:#1c1528; color:#a78bfa; border:1px solid #5b21b6 }
    .gherkin-label.gherkin-when { background:#131c2e; color:#60a5fa; border:1px solid #1e40af }
    .gherkin-label.gherkin-then { background:#132013; color:#4ade80; border:1px solid #166534 }
    .mermaid-flow { background:#0c0c0c; border:1px solid #1a1a1a; border-radius:8px; padding:16px; display:block }

    .module-grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .module-card { background: #161616; border: 1px solid #2a2a2a; border-radius: 10px; padding: 14px; }
    .module-card h4 { margin: 0 0 7px 0; font-size: 13px; }
    .module-card .path { font-size: 11px; color: #666; font-family: SFMono-Regular, Menlo, monospace; margin-bottom: 8px; }
    .module-card p { margin: 0; font-size: 12px; color: #999; line-height: 1.45; }
    .dir-tree { background: #161616; border: 1px solid #2a2a2a; border-radius: 10px; padding: 12px; font-size: 11px; line-height: 1.7; font-family: SFMono-Regular, Menlo, monospace; white-space: pre; color: #888; }
    .dir { color: #60a5fa; }
    .hub { color: #a78bfa; font-weight: 700; }

    .nav-grid { display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .nav-card { background: #161616; border: 1px solid #2a2a2a; border-radius: 10px; padding: 12px; }
    .nav-card h4 { margin: 0 0 8px 0; font-size: 12px; color: #ddd; }
    .nav-card code { color: #93c5fd; font-family: SFMono-Regular, Menlo, monospace; font-size: 11px; }

    .comment { background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 8px; padding: 8px; margin: 7px 0; font-size: 11px; color: #888; }

    .modal { position: fixed; inset: 0; background: #000a; display: none; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-box { width: 360px; background: #161616; border: 1px solid #2a2a2a; border-radius: 10px; padding: 14px; }
    .modal-box h4 { margin: 0 0 10px 0; font-size: 13px; }
    .modal-box textarea { width: 100%; height: 80px; background: #0c0c0c; color: #ddd; border: 1px solid #2a2a2a; border-radius: 6px; padding: 8px; font-size: 12px; }
    .modal-actions { margin-top: 10px; display: flex; justify-content: flex-end; gap: 8px; }
    .modal-actions button { border: 1px solid #2a2a2a; background: #1a1a1a; color: #bbb; border-radius: 6px; font-size: 11px; padding: 6px 10px; cursor: pointer; }
    .modal-actions .ok { border-color: #2563eb; background: #131c2e; color: #cfe6ff; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Invest <small>40 files · Bun/TypeScript pipeline</small></div>
    <div class="tabs">
      <button class="tab-btn active" data-tab="overview">Overview</button>
      <button class="tab-btn" data-tab="architecture">Architecture</button>
      <button class="tab-btn" data-tab="dependencies">Dependencies</button>
      <button class="tab-btn" data-tab="flows">Flows</button>
      <button class="tab-btn" data-tab="modules">Modules</button>
    </div>
  </div>

  <section id="panel-overview" class="tab-panel active">
    <div class="scroll">
      <div class="section">
        <h3>Tech Stack</h3>
        <div class="badge-row">
          <span class="badge b-client">TypeScript</span>
          <span class="badge b-client">Bun Runtime</span>
          <span class="badge b-client">Chart.js</span>
          <span class="badge b-core">Native fetch</span>
          <span class="badge b-core">Cheerio scraping</span>
          <span class="badge b-ext">TwelveData API</span>
          <span class="badge b-ext">FreeGoldAPI</span>
          <span class="badge b-ext">VNAppMob</span>
          <span class="badge b-data">JSON artifacts</span>
          <span class="badge b-infra">GitHub Actions + Pages</span>
        </div>
      </div>

      <div class="section">
        <h3>Key Metrics</h3>
        <div class="cards metrics">
          <div class="card"><div class="metric-num">40</div><div class="metric-label">Files</div></div>
          <div class="card"><div class="metric-num">70</div><div class="metric-label">Functions</div></div>
          <div class="card"><div class="metric-num">2</div><div class="metric-label">Hub Files</div></div>
          <div class="card"><div class="metric-num">6</div><div class="metric-label">Layer Groups</div></div>
          <div class="card"><div class="metric-num">4</div><div class="metric-label">Critical Flows</div></div>
          <div class="card"><div class="metric-num">0</div><div class="metric-label">Layer Violations</div></div>
        </div>
      </div>

      <div class="section">
        <h3>Hub Files</h3>
        <div class="card">
          <table>
            <thead>
              <tr><th>File</th><th>Dependents</th><th>Stability</th><th>Risk</th><th>Role</th></tr>
            </thead>
            <tbody>
              <tr><td><code>src/types.ts</code></td><td>12 direct</td><td>Stable</td><td class="risk-high">High</td><td>Domain contracts across all adapters/pipelines</td></tr>
              <tr><td><code>src/constants.ts</code></td><td>5 direct</td><td>Stable</td><td class="risk-med">Medium</td><td>Unit conversion and historical FX defaults</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <h3>Conventions</h3>
        <div class="card">
          <ul class="dot-list">
            <li>Adapters expose <code>fetchAll()</code> or <code>fetchCurrent/fetchHistory</code> returning <code>FetchResult&lt;T&gt;</code>.</li>
            <li>Pipeline tasks are executable CLI modules using <code>main().catch(...)</code> or <code>import.meta.main</code>.</li>
            <li>Artifacts are persisted under <code>data/</code> and used by downstream dashboard rendering.</li>
            <li>Provider credentials and runtime behavior are configured through environment variables.</li>
          </ul>
        </div>
      </div>

      <div class="section">
        <h3>Gotchas</h3>
        <div class="warn">Tree-sitter output was empty during mapping; dependency counts are regex-derived.</div>
        <div class="warn">Scraping adapters (<code>vietnam</code>, <code>india</code>, <code>premium</code>) are fragile against website markup changes.</div>
        <div class="warn">Historical premium uses fixed FX default unless <code>HISTORICAL_EXCHANGE_RATE</code> is provided.</div>
        <div class="warn"><code>generate-dashboard.ts</code> is monolithic and mixes UI + calculation logic.</div>
      </div>
    </div>
  </section>

  <section id="panel-architecture" class="tab-panel">
    <div class="arch-layout">
      <aside class="sidebar">
        <div class="side-sec">
          <h4>View Presets</h4>
          <div class="preset-grid" id="preset-grid"></div>
        </div>
        <div class="side-sec">
          <h4>Layer Toggles</h4>
          <div id="layer-toggles"></div>
        </div>
        <div class="side-sec">
          <h4>Connection Types</h4>
          <div id="conn-toggles"></div>
        </div>
        <div class="side-sec">
          <h4>Search</h4>
          <input id="search-input" class="search" placeholder="module/file name" />
        </div>
        <div class="side-sec" style="border-bottom:none">
          <h4>Annotations (<span id="comment-count">0</span>)</h4>
          <div id="comments"></div>
        </div>
      </aside>
      <div>
        <div class="canvas-wrap" id="arch-canvas">
          <div class="overlay-controls">
            <button id="zoom-out">-</button>
            <button id="zoom-in">+</button>
            <button id="zoom-fit">fit</button>
            <div class="zoom" id="zoom-text">100%</div>
          </div>
          <div class="legend">
            <h5>Connections</h5>
            <div class="row"><span class="line" style="border-color:#3b82f6"></span>data-flow</div>
            <div class="row"><span class="line" style="border-color:#525252;border-top-style:dashed"></span>dependency</div>
            <div class="row"><span class="line" style="border-color:#ef4444;border-top-style:dashed"></span>event</div>
            <div class="row"><span class="line" style="border-color:#10b981;border-top-style:dashed"></span>calls</div>
          </div>
        </div>
        <div class="prompt">
          <div class="prompt-head">
            <span>Prompt Output</span>
            <button class="copy" id="copy-prompt">Copy</button>
          </div>
          <div class="prompt-body" id="prompt-output"></div>
        </div>
      </div>
    </div>
  </section>

  <section id="panel-dependencies" class="tab-panel">
    <div class="scroll">
      <div class="section">
        <h3>Dependency Diagram</h3>
        <div class="dep-graph" id="dep-graph"></div>
      </div>

      <div class="section">
        <h3>Change Impact Analysis</h3>
        <div class="card">
          <table>
            <thead>
              <tr><th>Module</th><th>Affected Files If Changed</th><th>Risk</th><th>Recommendation</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><code>src/types.ts</code></td>
                <td><code>fetch-all.ts</code>, <code>fetch-history.ts</code>, source adapters, plus indirect <code>collect-daily.ts</code>/<code>backfill-vietnam.ts</code>/<code>update-vietnam-daily.ts</code></td>
                <td class="risk-high">High</td>
                <td>Additive schema updates first; run every pipeline command before merge.</td>
              </tr>
              <tr>
                <td><code>src/constants.ts</code></td>
                <td><code>fetch-long-history.ts</code>, <code>backfill-vietnam.ts</code>, <code>update-vietnam-daily.ts</code>, intl/twelvedata adapters</td>
                <td class="risk-med">Medium</td>
                <td>Guard with conversion regression checks around oz↔gram↔tael and premium formulas.</td>
              </tr>
              <tr>
                <td><code>src/sources/twelvedata/index.ts</code></td>
                <td><code>international/index.ts</code>, <code>fetch-long-history.ts</code>, <code>backfill-vietnam.ts</code>, <code>update-vietnam-daily.ts</code></td>
                <td class="risk-med">Medium</td>
                <td>Preserve response shape and fallback behavior; verify both current + history flows.</td>
              </tr>
              <tr>
                <td><code>src/sources/exchange-rate/index.ts</code></td>
                <td><code>fetch-all.ts</code>, <code>fetch-history.ts</code>, <code>collect-daily.ts</code>, <code>fetch-long-history.ts</code></td>
                <td class="risk-med">Medium</td>
                <td>Keep currency keys stable (<code>VND/CNY/RUB/INR</code>); test missing-rate fallback path.</td>
              </tr>
              <tr>
                <td><code>src/main.ts</code></td>
                <td>Daily build ordering, generated artifacts, deployment workflow expectations</td>
                <td class="risk-low">Low</td>
                <td>Safe for logging and sequencing tweaks; avoid changing output file contracts.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <h3>Coupling Analysis</h3>
        <div class="cards" style="grid-template-columns:repeat(auto-fit,minmax(280px,1fr))">
          <div class="card">
            <div style="font-size:13px;font-weight:700;margin-bottom:8px">Main Entry Point (✓)</div>
            <div style="font-size:12px;color:#999;line-height:1.5">`src/main.ts` is a clean orchestrator with downstream script delegation. Coupling is intentional and procedural.</div>
          </div>
          <div class="card">
            <div style="font-size:13px;font-weight:700;margin-bottom:8px">Feature Modules (✓)</div>
            <div style="font-size:12px;color:#999;line-height:1.5">Task modules (`fetch-all`, `collect-daily`, `analyze-drawdowns`) are separated by concern and communicate through file artifacts and shared contracts.</div>
          </div>
          <div class="card">
            <div style="font-size:13px;font-weight:700;margin-bottom:8px">Hub Coupling (!)</div>
            <div style="font-size:12px;color:#999;line-height:1.5">`src/types.ts` is highly central. Any type breaking change cascades across nearly all adapters and collectors.</div>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>Dependency Health</h3>
        <div class="card" style="display:grid;grid-template-columns:120px 1fr;gap:16px;align-items:center;margin-bottom:12px">
          <div style="width:96px;height:96px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:46px;font-weight:800;background:#132013;border:2px solid #166534;color:#4ade80">A</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;color:#999">
            <div>Acyclic: <span style="color:#4ade80">Good</span></div>
            <div>Layered: <span style="color:#4ade80">Good</span></div>
            <div>Hubs: <span style="color:#fbbf24">Watch</span></div>
            <div>Coupling: <span style="color:#4ade80">Good</span></div>
          </div>
        </div>
        <div class="card">
          <div style="font-size:12px;color:#bbb;margin-bottom:8px">What This Means</div>
          <ul class="dot-list">
            <li>Safe to modify: <code>src/main.ts</code>, <code>src/backfill.ts</code>, dashboard presentation styles.</li>
            <li>Plan changes for: <code>src/sources/twelvedata/index.ts</code>, <code>src/sources/exchange-rate/index.ts</code>.</li>
            <li>Test thoroughly: <code>src/types.ts</code>, <code>src/constants.ts</code>, premium calculation pipeline.</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <section id="panel-flows" class="tab-panel">
    <div class="scroll">
      <div class="flow-section">
        <div class="flow-header"><div class="flow-title">Daily Build and Publish</div><div class="flow-meta">src/main.ts + .github/workflows/collect-daily.yml</div></div>
        <div class="flow-gherkin">
          <span class="gherkin-label gherkin-given">Given</span> Scheduled daily workflow or manual build trigger
          <span class="gherkin-label gherkin-when">When</span> <code>bun run build</code> executes pipeline scripts
          <span class="gherkin-label gherkin-then">Then</span> Fresh artifacts are generated and dashboard is published
        </div>
        <pre class="mermaid-flow">flowchart LR
        A["GitHub Actions / Maintainer"] --> B["main.ts"]
        B --> C["fetch-all.ts"]
        C --> D["data/latest.json"]
        B --> E["collect-daily.ts"]
        E --> F["data/vietnam-history.json"]
        B --> G["analyze-drawdowns.ts"]
        G --> H["data/drawdowns.json"]
        B --> I["generate-dashboard.ts"]
        I --> J["data/dashboard.html"]
        J --> K["GitHub Pages Deploy"]
        style B fill:#131c2e,stroke:#60a5fa,stroke-width:2px
        style J fill:#132013,stroke:#4ade80,stroke-width:2px</pre>
      </div>

      <div class="flow-section">
        <div class="flow-header"><div class="flow-title">International Price Fallback Resolution</div><div class="flow-meta">src/sources/international/index.ts</div></div>
        <div class="flow-gherkin">
          <span class="gherkin-label gherkin-given">Given</span> A request for current or historical XAU/USD price
          <span class="gherkin-label gherkin-when">When</span> Primary source fails or key is missing
          <span class="gherkin-label gherkin-then">Then</span> Fallback providers are attempted in order
        </div>
        <pre class="mermaid-flow">flowchart TD
        Q["Task calls international.fetchAll/fetchHistory"] --> T["Try TwelveData"]
        T -->|"success"| OK["Return data"]
        T -->|"failure"| F["Try FreeGoldAPI"]
        F -->|"success"| OK
        F -->|"failure + GOLDAPI_KEY"| G["Try GoldAPI.io"]
        G --> R["Return best result or error"]
        style T fill:#131c2e,stroke:#60a5fa,stroke-width:2px
        style G fill:#1c1528,stroke:#a78bfa,stroke-width:2px
        style OK fill:#132013,stroke:#4ade80,stroke-width:2px</pre>
      </div>

      <div class="flow-section">
        <div class="flow-header"><div class="flow-title">Regional Aggregation and VND Normalization</div><div class="flow-meta">src/fetch-all.ts</div></div>
        <div class="flow-gherkin">
          <span class="gherkin-label gherkin-given">Given</span> Source adapters and exchange rates are available
          <span class="gherkin-label gherkin-when">When</span> Collector fetches multi-country spot prices in parallel
          <span class="gherkin-label gherkin-then">Then</span> All quotes are normalized to VND and premium is computed
        </div>
        <pre class="mermaid-flow">flowchart LR
        A1["fetch-all.ts"] --> FX["exchange-rate adapter"]
        A1 --> I1["international"]
        A1 --> V1["vietnam"]
        A1 --> C1["china"]
        A1 --> R1["russia"]
        A1 --> N1["india"]
        FX --> NORM["normalizeToVND()"]
        I1 --> NORM
        V1 --> NORM
        C1 --> NORM
        R1 --> NORM
        N1 --> NORM
        NORM --> P["calculateVietnamPremium()"]
        P --> OUT["data/latest.json"]
        style NORM fill:#132013,stroke:#4ade80,stroke-width:2px
        style OUT fill:#131c2e,stroke:#60a5fa,stroke-width:2px</pre>
      </div>

      <div class="flow-section">
        <div class="flow-header"><div class="flow-title">Weekly Historical Backfill</div><div class="flow-meta">src/backfill.ts + src/backfill-vietnam.ts</div></div>
        <div class="flow-gherkin">
          <span class="gherkin-label gherkin-given">Given</span> Weekly scheduler starts backfill pipeline
          <span class="gherkin-label gherkin-when">When</span> International and Vietnam history are fetched and aligned
          <span class="gherkin-label gherkin-then">Then</span> Historical files are merged and committed
        </div>
        <pre class="mermaid-flow">flowchart TD
        W["weekly workflow"] --> B["backfill.ts"]
        B --> H1["fetch-history.ts"]
        H1 --> T1["TwelveData history"]
        H1 --> F1["data/history.json + csv"]
        B --> V2["backfill-vietnam.ts"]
        V2 --> WV["webgia Vietnam history"]
        V2 --> T2["TwelveData 400-day history"]
        V2 --> M["match nearest trading date (+/-3 days)"]
        M --> F2["data/vietnam-history.json"]
        style M fill:#1f1a0f,stroke:#fbbf24,stroke-width:2px
        style F2 fill:#132013,stroke:#4ade80,stroke-width:2px</pre>
      </div>
    </div>
  </section>

  <section id="panel-modules" class="tab-panel">
    <div class="scroll">
      <div class="section">
        <h3>Directory Structure</h3>
        <div class="dir-tree">.
├── <span class="dir">.github/workflows/</span>
├── <span class="dir">data/</span>
├── <span class="dir">docs/</span>
├── <span class="dir">src/</span>
│   ├── main.ts
│   ├── backfill.ts
│   ├── fetch-all.ts
│   ├── fetch-history.ts
│   ├── fetch-long-history.ts
│   ├── collect-daily.ts
│   ├── backfill-vietnam.ts
│   ├── update-vietnam-daily.ts
│   ├── analyze-drawdowns.ts
│   ├── generate-dashboard.ts
│   ├── <span class="hub">types.ts</span>
│   ├── <span class="hub">constants.ts</span>
│   └── <span class="dir">sources/</span>
│       ├── international/
│       ├── twelvedata/
│       ├── exchange-rate/
│       ├── vietnam/
│       ├── vnappmob/
│       ├── china/
│       ├── russia/
│       ├── india/
│       └── premium/
└── CLAUDE.md</div>
      </div>

      <div class="section">
        <h3>Module Guide</h3>
        <div class="module-grid">
          <div class="module-card"><h4>Orchestration</h4><div class="path">src/main.ts, src/backfill.ts</div><p>Coordinates end-to-end daily and weekly job execution order.</p></div>
          <div class="module-card"><h4>Pipeline Tasks</h4><div class="path">src/fetch-*.ts, src/collect-daily.ts, src/analyze-drawdowns.ts</div><p>Implements core fetching, transformation, analytics, and output generation operations.</p></div>
          <div class="module-card"><h4>Source Adapters</h4><div class="path">src/sources/*</div><p>Provider integrations with fallback chain and region-specific scraping/API logic.</p></div>
          <div class="module-card"><h4>Shared Contracts</h4><div class="path">src/types.ts, src/constants.ts</div><p>Defines data contracts and conversion constants consumed by most modules.</p></div>
        </div>
      </div>

      <div class="section">
        <h3>Navigation Guide</h3>
        <div class="nav-grid">
          <div class="nav-card"><h4>Add a new market source</h4><code>src/sources/&lt;new&gt;/index.ts</code><br/><code>src/fetch-all.ts</code></div>
          <div class="nav-card"><h4>Adjust normalization or premium logic</h4><code>src/fetch-all.ts</code><br/><code>src/sources/premium/index.ts</code><br/><code>src/constants.ts</code></div>
          <div class="nav-card"><h4>Change historical behavior</h4><code>src/fetch-history.ts</code><br/><code>src/fetch-long-history.ts</code><br/><code>src/backfill-vietnam.ts</code></div>
          <div class="nav-card"><h4>Change UI/dashboard output</h4><code>src/generate-dashboard.ts</code><br/><code>data/dashboard.html</code></div>
          <div class="nav-card"><h4>Adjust schedules and deploy behavior</h4><code>.github/workflows/collect-daily.yml</code><br/><code>.github/workflows/backfill.yml</code></div>
        </div>
      </div>

      <div class="section">
        <h3>Environment Variables</h3>
        <div class="card">
          <table>
            <thead><tr><th>Variable</th><th>Required</th><th>Description</th><th>Example</th></tr></thead>
            <tbody>
              <tr><td><code>TWELVEDATA_API_KEY</code></td><td>Yes</td><td>Primary international XAU/USD provider key</td><td><code>td_xxx</code></td></tr>
              <tr><td><code>VNAPPMOB_API_KEY</code></td><td>Conditional</td><td>Bearer token for VNAppMob current SJC API</td><td><code>vna_xxx</code></td></tr>
              <tr><td><code>GOLDAPI_KEY</code></td><td>No</td><td>Last-resort fallback source key</td><td><code>goldapi_xxx</code></td></tr>
              <tr><td><code>METALS_DEV_KEY</code></td><td>No</td><td>India adapter fallback API key</td><td><code>metals_xxx</code></td></tr>
              <tr><td><code>HISTORICAL_EXCHANGE_RATE</code></td><td>No</td><td>Override fixed historical USD/VND rate for backfill</td><td><code>25500</code></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <div class="modal" id="comment-modal">
    <div class="modal-box">
      <h4 id="modal-title">Add annotation</h4>
      <textarea id="modal-text" placeholder="note for this node"></textarea>
      <div class="modal-actions">
        <button id="modal-cancel">Cancel</button>
        <button class="ok" id="modal-save">Save</button>
      </div>
    </div>
  </div>

  <script>
    const LAYERS = {
      external: { label: 'External', color: '#a78bfa', bg: '#1c1528', y: 80 },
      client: { label: 'Client/UI', color: '#60a5fa', bg: '#131c2e', y: 170 },
      api: { label: 'API/Server', color: '#fbbf24', bg: '#1f1a0f', y: 250 },
      core: { label: 'Core/Logic', color: '#4ade80', bg: '#132013', y: 330 },
      data: { label: 'Data', color: '#f472b6', bg: '#1f1320', y: 410 },
      infra: { label: 'Infrastructure', color: '#94a3b8', bg: '#181818', y: 500 }
    };

    const CONNECTIONS = {
      'data-flow': { color: '#3b82f6', dash: '', width: 2 },
      dependency: { color: '#525252', dash: '6,4', width: 1.5 },
      event: { color: '#ef4444', dash: '3,4', width: 1.5 },
      calls: { color: '#10b981', dash: '8,4', width: 1.5 }
    };

    const nodes = [
      { id: 'maintainer', label: 'Maintainer', path: 'CLI', layer: 'external' },
      { id: 'gha', label: 'GitHub Actions', path: '.github/workflows', layer: 'external' },
      { id: 'pages', label: 'GitHub Pages', path: 'deploy-pages', layer: 'external' },
      { id: 'providers', label: 'Data Providers', path: 'TwelveData/FreeGold/VNAppMob', layer: 'external' },
      { id: 'main', label: 'main.ts', path: 'src/main.ts', layer: 'client' },
      { id: 'backfill', label: 'backfill.ts', path: 'src/backfill.ts', layer: 'client' },
      { id: 'fetch_all', label: 'fetch-all.ts', path: 'src/fetch-all.ts', layer: 'api' },
      { id: 'collect', label: 'collect-daily.ts', path: 'src/collect-daily.ts', layer: 'api' },
      { id: 'drawdowns', label: 'analyze-drawdowns.ts', path: 'src/analyze-drawdowns.ts', layer: 'api' },
      { id: 'dashboard', label: 'generate-dashboard.ts', path: 'src/generate-dashboard.ts', layer: 'api' },
      { id: 'fetch_history', label: 'fetch-history.ts', path: 'src/fetch-history.ts', layer: 'api' },
      { id: 'backfill_vn', label: 'backfill-vietnam.ts', path: 'src/backfill-vietnam.ts', layer: 'api' },
      { id: 'sources', label: 'source adapters', path: 'src/sources/*', layer: 'core' },
      { id: 'types', label: 'types.ts', path: 'src/types.ts', layer: 'core', hub: true },
      { id: 'constants', label: 'constants.ts', path: 'src/constants.ts', layer: 'core', hub: true },
      { id: 'artifact_json', label: 'JSON Artifacts', path: 'data/*.json', layer: 'data' },
      { id: 'dashboard_html', label: 'dashboard.html', path: 'data/dashboard.html', layer: 'data' },
      { id: 'ci', label: 'CI/CD Pipelines', path: '.github/workflows/*.yml', layer: 'infra' }
    ];

    const edges = [
      { from: 'maintainer', to: 'main', type: 'calls', label: 'bun run build' },
      { from: 'gha', to: 'main', type: 'calls', label: 'collect-daily workflow' },
      { from: 'gha', to: 'backfill', type: 'calls', label: 'weekly backfill workflow' },
      { from: 'main', to: 'fetch_all', type: 'calls', label: 'step 1' },
      { from: 'main', to: 'collect', type: 'calls', label: 'step 2' },
      { from: 'main', to: 'drawdowns', type: 'calls', label: 'step 3' },
      { from: 'main', to: 'dashboard', type: 'calls', label: 'step 4' },
      { from: 'backfill', to: 'fetch_history', type: 'calls', label: 'history refresh' },
      { from: 'backfill', to: 'backfill_vn', type: 'calls', label: 'vn merge' },
      { from: 'fetch_all', to: 'sources', type: 'dependency', label: 'imports adapters' },
      { from: 'collect', to: 'sources', type: 'dependency', label: 'imports adapters' },
      { from: 'fetch_history', to: 'sources', type: 'dependency', label: 'intl + fx' },
      { from: 'backfill_vn', to: 'sources', type: 'dependency', label: 'vn/twelvedata' },
      { from: 'sources', to: 'types', type: 'dependency', label: 'shared contracts' },
      { from: 'fetch_all', to: 'types', type: 'dependency', label: 'result types' },
      { from: 'fetch_history', to: 'types', type: 'dependency', label: 'history types' },
      { from: 'sources', to: 'constants', type: 'dependency', label: 'unit constants' },
      { from: 'fetch_all', to: 'artifact_json', type: 'data-flow', label: 'latest.json' },
      { from: 'collect', to: 'artifact_json', type: 'data-flow', label: 'vietnam-history.json' },
      { from: 'drawdowns', to: 'artifact_json', type: 'data-flow', label: 'drawdowns.json' },
      { from: 'fetch_history', to: 'artifact_json', type: 'data-flow', label: 'history.json' },
      { from: 'backfill_vn', to: 'artifact_json', type: 'data-flow', label: 'merge history' },
      { from: 'dashboard', to: 'dashboard_html', type: 'data-flow', label: 'render html' },
      { from: 'dashboard_html', to: 'pages', type: 'event', label: 'static deploy' },
      { from: 'artifact_json', to: 'ci', type: 'event', label: 'commit artifacts' },
      { from: 'sources', to: 'providers', type: 'calls', label: 'HTTPS API/scrape' },
      { from: 'ci', to: 'gha', type: 'event', label: 'schedule/trigger' }
    ];

    const depNodes = [
      { id: 'main', label: 'src/main.ts', layer: 'client', hub: false },
      { id: 'backfill', label: 'src/backfill.ts', layer: 'client', hub: false },
      { id: 'fetch_all', label: 'src/fetch-all.ts', layer: 'api', hub: false },
      { id: 'fetch_history', label: 'src/fetch-history.ts', layer: 'api', hub: false },
      { id: 'fetch_long', label: 'src/fetch-long-history.ts', layer: 'api', hub: false },
      { id: 'collect', label: 'src/collect-daily.ts', layer: 'api', hub: false },
      { id: 'backfill_vn', label: 'src/backfill-vietnam.ts', layer: 'api', hub: false },
      { id: 'sources_intl', label: 'sources/international', layer: 'core', hub: false },
      { id: 'sources_fx', label: 'sources/exchange-rate', layer: 'core', hub: false },
      { id: 'sources_tw', label: 'sources/twelvedata', layer: 'core', hub: false },
      { id: 'types', label: 'src/types.ts', layer: 'core', hub: true },
      { id: 'constants', label: 'src/constants.ts', layer: 'core', hub: true }
    ];

    const depEdges = [
      ['main', 'fetch_all'], ['main', 'collect'], ['backfill', 'fetch_history'], ['backfill', 'backfill_vn'],
      ['fetch_all', 'sources_intl'], ['fetch_all', 'sources_fx'], ['fetch_all', 'types'],
      ['fetch_history', 'sources_intl'], ['fetch_history', 'sources_fx'], ['fetch_history', 'types'],
      ['fetch_long', 'sources_tw'], ['fetch_long', 'sources_fx'], ['fetch_long', 'constants'],
      ['collect', 'sources_intl'], ['collect', 'sources_fx'],
      ['backfill_vn', 'sources_tw'], ['backfill_vn', 'constants'],
      ['sources_intl', 'sources_tw'], ['sources_intl', 'types'], ['sources_intl', 'constants'],
      ['sources_fx', 'types'], ['sources_tw', 'types'], ['sources_tw', 'constants']
    ].map(([source, target]) => ({ source, target }));

    const state = {
      activeTab: 'overview',
      layers: { external: true, client: true, api: true, core: true, data: true, infra: true },
      conns: { 'data-flow': true, dependency: true, event: true, calls: true },
      comments: [],
      search: '',
      hoveredNode: null,
      zoom: 1,
      selectedPreset: 'full'
    };

    const presets = {
      full: { label: 'Full', layers: { external: true, client: true, api: true, core: true, data: true, infra: true }, conns: { 'data-flow': true, dependency: true, event: true, calls: true } },
      runtime: { label: 'Runtime', layers: { external: true, client: true, api: true, core: true, data: false, infra: false }, conns: { 'data-flow': false, dependency: true, event: false, calls: true } },
      data: { label: 'Data', layers: { external: false, client: false, api: true, core: true, data: true, infra: false }, conns: { 'data-flow': true, dependency: false, event: false, calls: false } },
      deploy: { label: 'Deploy', layers: { external: true, client: false, api: false, core: false, data: true, infra: true }, conns: { 'data-flow': true, dependency: false, event: true, calls: false } }
    };

    let archSvg, archG, archZoom, archSim, depInited = false, flowsInited = false;
    let currentArchNodes = [], currentArchLinks = [];
    let modalNodeId = null;

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        state.activeTab = tab;
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        document.getElementById(`panel-${tab}`).classList.add('active');
        if (tab === 'dependencies' && !depInited) initDepGraph();
        if (tab === 'flows' && !flowsInited) renderFlows();
      });
    });

    function buildSidebarControls() {
      const presetGrid = document.getElementById('preset-grid');
      Object.entries(presets).forEach(([key, cfg]) => {
        const b = document.createElement('button');
        b.className = `preset ${key === state.selectedPreset ? 'active' : ''}`;
        b.textContent = cfg.label;
        b.onclick = () => {
          state.selectedPreset = key;
          state.layers = { ...cfg.layers };
          state.conns = { ...cfg.conns };
          buildSidebarControls();
          rebuildArch();
        };
        presetGrid.appendChild(b);
      });

      const layers = document.getElementById('layer-toggles');
      layers.innerHTML = '';
      Object.entries(LAYERS).forEach(([k, l]) => {
        const row = document.createElement('label');
        row.className = 'side-row';
        row.innerHTML = `<input type="checkbox" ${state.layers[k] ? 'checked' : ''} /><span style="width:8px;height:8px;border-radius:50%;background:${l.color}"></span>${l.label}`;
        row.querySelector('input').onchange = (e) => { state.layers[k] = e.target.checked; state.selectedPreset = ''; buildSidebarControls(); rebuildArch(); };
        layers.appendChild(row);
      });

      const conns = document.getElementById('conn-toggles');
      conns.innerHTML = '';
      Object.entries(CONNECTIONS).forEach(([k, c]) => {
        const row = document.createElement('label');
        row.className = 'side-row';
        row.innerHTML = `<input type="checkbox" ${state.conns[k] ? 'checked' : ''} /><span style="width:12px;border-top:${c.width}px ${c.dash ? 'dashed' : 'solid'} ${c.color}"></span>${k}`;
        row.querySelector('input').onchange = (e) => { state.conns[k] = e.target.checked; state.selectedPreset = ''; buildSidebarControls(); rebuildArch(); };
        conns.appendChild(row);
      });

      document.getElementById('comment-count').textContent = state.comments.length;
      const comments = document.getElementById('comments');
      comments.innerHTML = state.comments.map((c, i) => `<div class="comment"><b>${c.node}</b><br/>${c.text}<div style="margin-top:6px"><button class="copy" data-del="${i}">remove</button></div></div>`).join('');
      comments.querySelectorAll('[data-del]').forEach(b => b.onclick = () => { state.comments.splice(Number(b.dataset.del), 1); buildSidebarControls(); updatePrompt(); });
    }

    function initArchGraph() {
      const wrap = document.getElementById('arch-canvas');
      const w = wrap.clientWidth;
      const h = wrap.clientHeight;

      archSvg = d3.select(wrap).append('svg').attr('width', '100%').attr('height', '100%').attr('viewBox', `0 0 ${w} ${h}`);
      const defs = archSvg.append('defs');
      Object.entries(CONNECTIONS).forEach(([k, c]) => {
        defs.append('marker')
          .attr('id', `arr-${k}`)
          .attr('markerWidth', 8).attr('markerHeight', 6).attr('refX', 7).attr('refY', 3).attr('orient', 'auto')
          .append('polygon').attr('points', '0 0,8 3,0 6').attr('fill', c.color).attr('opacity', 1);
      });

      archG = archSvg.append('g');
      archZoom = d3.zoom().scaleExtent([0.3, 4]).on('zoom', (e) => {
        archG.attr('transform', e.transform);
        state.zoom = e.transform.k;
        document.getElementById('zoom-text').textContent = `${Math.round(state.zoom * 100)}%`;
      });
      archSvg.call(archZoom);

      document.getElementById('zoom-in').onclick = () => archSvg.transition().call(archZoom.scaleBy, 1.2);
      document.getElementById('zoom-out').onclick = () => archSvg.transition().call(archZoom.scaleBy, 0.8);
      document.getElementById('zoom-fit').onclick = () => archSvg.transition().call(archZoom.transform, d3.zoomIdentity.translate(30, 20).scale(0.95));

      document.getElementById('search-input').addEventListener('input', (e) => { state.search = e.target.value.toLowerCase().trim(); rebuildArch(); });
      rebuildArch();
    }

    function rebuildArch() {
      const wrap = document.getElementById('arch-canvas');
      const w = wrap.clientWidth;
      const h = wrap.clientHeight;
      archG.selectAll('*').remove();

      currentArchNodes = nodes.filter(n => state.layers[n.layer] && (!state.search || n.label.toLowerCase().includes(state.search) || n.path.toLowerCase().includes(state.search)));
      const visibleIds = new Set(currentArchNodes.map(n => n.id));
      currentArchLinks = edges.filter(e => state.conns[e.type] && visibleIds.has(e.from) && visibleIds.has(e.to));

      Object.values(LAYERS).forEach(layer => {
        if (!state.layers[Object.keys(LAYERS).find(k => LAYERS[k] === layer)]) return;
        archG.append('rect').attr('x', 0).attr('y', layer.y - 34).attr('width', w).attr('height', 68).attr('fill', layer.bg).attr('opacity', .22);
        archG.append('text').attr('x', 12).attr('y', layer.y - 16).attr('font-size', 9).attr('fill', layer.color).attr('opacity', .75).text(layer.label.toUpperCase());
      });

      const simNodes = currentArchNodes.map(n => ({ ...n }));
      const simLinks = currentArchLinks.map(e => ({ ...e }));

      const link = archG.append('g').selectAll('path').data(simLinks).enter().append('path')
        .attr('fill', 'none')
        .attr('stroke', d => CONNECTIONS[d.type].color)
        .attr('stroke-width', d => CONNECTIONS[d.type].width)
        .attr('stroke-dasharray', d => CONNECTIONS[d.type].dash)
        .attr('opacity', 0.35)
        .attr('marker-end', d => `url(#arr-${d.type})`);

      const linkLabel = archG.append('g').selectAll('text').data(simLinks).enter().append('text')
        .attr('font-size', 8).attr('fill', '#aaa').attr('text-anchor', 'middle').attr('opacity', 0);

      const node = archG.append('g').selectAll('g').data(simNodes).enter().append('g').style('cursor', 'pointer');
      node.append('rect')
        .attr('x', d => d.hub ? -80 : -70)
        .attr('y', d => d.hub ? -24 : -20)
        .attr('width', d => d.hub ? 160 : 140)
        .attr('height', d => d.hub ? 48 : 40)
        .attr('rx', 8)
        .attr('fill', d => LAYERS[d.layer].bg)
        .attr('stroke', d => LAYERS[d.layer].color)
        .attr('stroke-width', d => d.hub ? 2 : 1);

      node.append('text').attr('text-anchor', 'middle').attr('y', -2).attr('font-size', 11).attr('font-weight', 600).attr('fill', d => LAYERS[d.layer].color).text(d => d.label);
      node.append('text').attr('text-anchor', 'middle').attr('y', 10).attr('font-size', 8).attr('opacity', .6).attr('fill', d => LAYERS[d.layer].color).text(d => d.path);
      node.filter(d => d.hub).append('text').attr('x', 66).attr('y', -14).attr('font-size', 7).attr('fill', d => LAYERS[d.layer].color).text('HUB');

      node.on('mouseenter', (_, n) => {
        const connected = new Set([n.id]);
        simLinks.forEach(l => {
          const s = typeof l.source === 'object' ? l.source.id : l.source;
          const t = typeof l.target === 'object' ? l.target.id : l.target;
          if (s === n.id) connected.add(t);
          if (t === n.id) connected.add(s);
        });

        node.style('opacity', d => connected.has(d.id) ? 1 : .08);
        link.attr('opacity', d => {
          const s = typeof d.source === 'object' ? d.source.id : d.source;
          const t = typeof d.target === 'object' ? d.target.id : d.target;
          return (s === n.id || t === n.id) ? .9 : .08;
        });
        linkLabel.attr('opacity', d => {
          const s = typeof d.source === 'object' ? d.source.id : d.source;
          const t = typeof d.target === 'object' ? d.target.id : d.target;
          return (s === n.id || t === n.id) ? .85 : 0;
        });
      });
      node.on('mouseleave', () => { node.style('opacity', 1); link.attr('opacity', .35); linkLabel.attr('opacity', 0); });
      node.on('click', (_, n) => openModal(n.id));

      node.call(d3.drag()
        .on('start', (e, d) => { if (!e.active) archSim.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
        .on('drag', (e, d) => { d.fx = e.x; d.fy = e.y; })
        .on('end', (e, d) => { if (!e.active) archSim.alphaTarget(0); d.fx = null; d.fy = null; })
      );

      const layerY = d => Math.min(h - 30, LAYERS[d.layer].y);
      archSim = d3.forceSimulation(simNodes)
        .force('link', d3.forceLink(simLinks).id(d => d.id).distance(120).strength(0.3))
        .force('charge', d3.forceManyBody().strength(-400))
        .force('center', d3.forceCenter(w / 2, h / 2))
        .force('y', d3.forceY(layerY).strength(0.3))
        .force('collide', d3.forceCollide(90));

      archSim.on('tick', () => {
        link.attr('d', d => {
          const sx = d.source.x, sy = d.source.y, tx = d.target.x, ty = d.target.y;
          const cx1 = sx + (tx - sx) * 0.35;
          const cx2 = sx + (tx - sx) * 0.65;
          return `M${sx},${sy} C${cx1},${sy} ${cx2},${ty} ${tx},${ty}`;
        });
        node.attr('transform', d => `translate(${d.x},${d.y})`);
        linkLabel
          .attr('x', d => (d.source.x + d.target.x) / 2)
          .attr('y', d => (d.source.y + d.target.y) / 2 - 4)
          .text(d => d.label || '');
      });

      updatePrompt();
    }

    function updatePrompt() {
      const summary = [
        `System: Invest Gold Tracker`,
        `Visible nodes: ${currentArchNodes.length}`,
        `Visible relationships: ${currentArchLinks.length}`,
        '',
        'Hubs:',
        '- src/types.ts (12 dependents)',
        '- src/constants.ts (5 dependents)',
        '',
        'Key flows: daily build, fallback pricing, regional normalization, weekly backfill',
        '',
        state.comments.length ? 'Annotations:' : 'Annotations: none'
      ];
      state.comments.forEach(c => summary.push(`- ${c.node}: ${c.text}`));
      document.getElementById('prompt-output').textContent = summary.join('\n');
    }

    function openModal(nodeId) {
      modalNodeId = nodeId;
      const node = nodes.find(n => n.id === nodeId);
      document.getElementById('modal-title').textContent = `Annotate: ${node.label}`;
      const existing = state.comments.find(c => c.nodeId === nodeId);
      document.getElementById('modal-text').value = existing ? existing.text : '';
      document.getElementById('comment-modal').classList.add('active');
    }

    document.getElementById('modal-cancel').onclick = () => document.getElementById('comment-modal').classList.remove('active');
    document.getElementById('comment-modal').onclick = (e) => { if (e.target.id === 'comment-modal') e.target.classList.remove('active'); };
    document.getElementById('modal-save').onclick = () => {
      const text = document.getElementById('modal-text').value.trim();
      const node = nodes.find(n => n.id === modalNodeId);
      const idx = state.comments.findIndex(c => c.nodeId === modalNodeId);
      if (!text && idx >= 0) state.comments.splice(idx, 1);
      else if (text && idx >= 0) state.comments[idx].text = text;
      else if (text) state.comments.push({ nodeId: modalNodeId, node: node.label, text });
      document.getElementById('comment-modal').classList.remove('active');
      buildSidebarControls();
      updatePrompt();
    };

    function initDepGraph() {
      depInited = true;
      const el = document.getElementById('dep-graph');
      const w = el.clientWidth, h = 450;
      const svg = d3.select(el).append('svg').attr('width', '100%').attr('height', '100%').attr('viewBox', `0 0 ${w} ${h}`);
      const defs = svg.append('defs');
      defs.append('marker')
        .attr('id', 'arrow')
        .attr('markerWidth', 8)
        .attr('markerHeight', 6)
        .attr('refX', 7)
        .attr('refY', 3)
        .attr('orient', 'auto')
        .append('polygon')
        .attr('points', '0 0,8 3,0 6')
        .attr('fill', '#888')
        .attr('opacity', 1);

      const g = svg.append('g');
      svg.call(d3.zoom().scaleExtent([0.3, 4]).on('zoom', e => g.attr('transform', e.transform)));

      const simNodes = depNodes.map(d => ({ ...d }));
      const simLinks = depEdges.map(d => ({ ...d }));

      const layerYMap = { client: 120, api: 230, core: 350, infra: 430, external: 80, data: 420 };
      const link = g.selectAll('path').data(simLinks).enter().append('path')
        .attr('stroke', '#888').attr('stroke-width', 1.5).attr('fill', 'none').attr('opacity', 0.6).attr('marker-end', 'url(#arrow)');

      const node = g.selectAll('g').data(simNodes).enter().append('g').attr('class', 'dep-node');
      node.append('rect')
        .attr('x', d => d.hub ? -74 : -62)
        .attr('y', d => d.hub ? -18 : -14)
        .attr('width', d => d.hub ? 148 : 124)
        .attr('height', d => d.hub ? 36 : 28)
        .attr('rx', 7)
        .attr('fill', d => LAYERS[d.layer].bg)
        .attr('stroke', d => LAYERS[d.layer].color)
        .attr('stroke-width', d => d.hub ? 2 : 1);
      node.append('text').attr('text-anchor', 'middle').attr('y', 3).attr('font-size', 10).attr('fill', d => LAYERS[d.layer].color).text(d => d.label);
      node.filter(d => d.hub).append('text').attr('x', 58).attr('y', -9).attr('font-size', 7).attr('fill', '#a78bfa').text('HUB');

      node.on('mouseenter', (_, n) => {
        const connected = new Set([n.id]);
        simLinks.forEach(l => {
          const s = typeof l.source === 'object' ? l.source.id : l.source;
          const t = typeof l.target === 'object' ? l.target.id : l.target;
          if (s === n.id) connected.add(t);
          if (t === n.id) connected.add(s);
        });
        node.style('opacity', d => connected.has(d.id) ? 1 : .15);
        link.attr('opacity', d => {
          const s = typeof d.source === 'object' ? d.source.id : d.source;
          const t = typeof d.target === 'object' ? d.target.id : d.target;
          return (s === n.id || t === n.id) ? .95 : .15;
        });
      }).on('mouseleave', () => { node.style('opacity', 1); link.attr('opacity', .6); });

      node.call(d3.drag()
        .on('start', (e, d) => { if (!e.active) sim.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
        .on('drag', (e, d) => { d.fx = e.x; d.fy = e.y; })
        .on('end', (e, d) => { if (!e.active) sim.alphaTarget(0); d.fx = null; d.fy = null; })
      );

      const sim = d3.forceSimulation(simNodes)
        .force('link', d3.forceLink(simLinks).id(d => d.id).distance(120).strength(0.3))
        .force('charge', d3.forceManyBody().strength(-300))
        .force('center', d3.forceCenter(w / 2, h / 2))
        .force('y', d3.forceY(d => layerYMap[d.layer] || 220).strength(0.3))
        .force('collide', d3.forceCollide(70));

      sim.on('tick', () => {
        link.attr('d', d => {
          const sx = d.source.x, sy = d.source.y, tx = d.target.x, ty = d.target.y;
          const cx1 = sx + (tx - sx) * .35;
          const cx2 = sx + (tx - sx) * .65;
          return `M${sx},${sy} C${cx1},${sy} ${cx2},${ty} ${tx},${ty}`;
        });
        node.attr('transform', d => `translate(${d.x},${d.y})`);
      });

      const legend = document.createElement('div');
      legend.className = 'legend';
      legend.innerHTML = `<h5>Layers</h5>
        <div class="row"><span style="width:8px;height:8px;border-radius:50%;background:#60a5fa"></span>entry/api</div>
        <div class="row"><span style="width:8px;height:8px;border-radius:50%;background:#4ade80"></span>core/shared</div>
        <div class="row"><span style="width:8px;height:8px;border-radius:50%;background:#a78bfa"></span>hub</div>`;
      el.appendChild(legend);
    }

    async function renderFlows() {
      flowsInited = true;
      mermaid.initialize({
        startOnLoad: false,
        theme: 'dark',
        themeVariables: {
          darkMode: true,
          background: '#0c0c0c',
          primaryColor: '#161616',
          primaryTextColor: '#e5e5e5',
          lineColor: '#525252'
        }
      });
      const blocks = document.querySelectorAll('.mermaid-flow');
      for (const block of blocks) {
        const src = block.textContent;
        try {
          const id = 'm' + Math.random().toString(36).slice(2);
          const { svg } = await mermaid.render(id, src);
          block.innerHTML = svg;
        } catch (e) {
          block.innerHTML = `<code style="color:#ef4444">Failed to render flow</code>`;
        }
      }
    }

    document.getElementById('copy-prompt').onclick = async () => {
      await navigator.clipboard.writeText(document.getElementById('prompt-output').textContent);
      const btn = document.getElementById('copy-prompt');
      const old = btn.textContent;
      btn.textContent = 'Copied';
      setTimeout(() => btn.textContent = old, 900);
    };

    buildSidebarControls();
    initArchGraph();
  </script>
</body>
</html>
