---
last_mapped: 2026-02-11T13:12:00Z
total_files: 40
total_files_scanned: 38
total_functions: 70
total_classes: 48
static_analysis: regex-fallback (tree-sitter produced empty graph)
confidence: 4
generated_docs:
  - CODEBASE_MAP.md
  - c4-architecture.md
  - key-flows.md
  - dependency-graph.md
  - api-surface.md
  - product-requirements.md
  - infrastructure.md
---

# Codebase Map

> Auto-generated by Codebase Oracle. Last mapped: 2026-02-11T13:12:00Z

## System Overview

This repository is a Bun/TypeScript batch pipeline for collecting gold prices from multiple global sources, converting everything into VND, and generating investment-oriented artifacts (history files, drawdown stats, and a static dashboard). It is designed to run both locally via CLI scripts and automatically via scheduled GitHub Actions workflows. The published output is a static GitHub Pages dashboard backed by generated files under `data/`.

**Stack**: Bun, TypeScript, native `fetch`, Cheerio, Chart.js, GitHub Actions/Pages
**Architecture**: Monorepo-style single-process batch pipeline with adapter modules and artifact-based outputs

## Static Analysis Metrics

| Metric | Count |
|--------|-------|
| Functions/Methods | 70 |
| Classes/Types | 48 |
| Imports | 41 |
| Exports | 35 |
| Call Relationships | 36 local import edges |

**Languages Parsed**: TypeScript (expected), but Tree-sitter output contained no parsed files in this run
**Import Graph Accuracy**: Fallback to regex-based import extraction due empty Tree-sitter graph

## Architecture Docs

| Document | Description |
|----------|-------------|
| [C4 Architecture](c4-architecture.md) | System context, containers, components |
| [Key Flows](key-flows.md) | Sequence diagrams for critical paths |
| [Dependency Graph](dependency-graph.md) | Module dependencies, hub analysis |
| [API Surface](api-surface.md) | CLI command surface and module APIs |
| [Product Requirements](product-requirements.md) | Reverse-engineered feature/role/rule map |
| [Infrastructure](infrastructure.md) | CI/CD schedules, deployment, env config |

## Hub Files

| Package | Dependents | Stability | Risk |
|---------|-----------|-----------|------|
| `src/types.ts` | 12 direct | Stable (2 commits in 6 months) | High |
| `src/constants.ts` | 5 direct | Stable (2 commits in 6 months) | Medium |

## Directory Structure

```text
.
├── .github/workflows/          # Scheduled automation and deployment pipelines
├── data/                       # Generated artifacts (json/csv/html) committed and published
├── docs/                       # Codebase oracle architecture documentation
├── src/                        # TypeScript pipeline code
│   ├── main.ts                 # Daily orchestrator entrypoint
│   ├── backfill.ts             # Weekly orchestrator entrypoint
│   ├── fetch-*.ts              # Collection/history jobs
│   ├── analyze-drawdowns.ts    # Drawdown analytics
│   ├── generate-dashboard.ts   # Static dashboard renderer
│   ├── types.ts                # Core data contracts (hub)
│   ├── constants.ts            # Unit conversion constants (hub)
│   └── sources/                # Provider adapters by market/provider
└── CLAUDE.md                   # Developer working guide
```

## Module Guide

### Orchestration

**Purpose**: Coordinate end-to-end daily and weekly runs.
**Layer**: Entry/Workflow
**Entry point**: `src/main.ts`, `src/backfill.ts`

| Directory | Purpose | Layer |
|-----------|---------|-------|
| `src/main.ts` | Daily pipeline chaining fetch, collect, analyze, render | Entry |
| `src/backfill.ts` | Weekly historical refresh and backfill | Entry |

### Pipeline Tasks

**Purpose**: Execute concrete collection/analysis/render jobs.
**Layer**: Application logic
**Entry point**: `src/fetch-all.ts`

| Directory | Purpose | Layer |
|-----------|---------|-------|
| `src/fetch-all.ts` | Multi-market current aggregation + normalization | Application |
| `src/fetch-history.ts` / `src/fetch-long-history.ts` | Historical data extraction and export | Application |
| `src/collect-daily.ts` / `src/backfill-vietnam.ts` / `src/update-vietnam-daily.ts` | Vietnam timeline maintenance | Application |
| `src/analyze-drawdowns.ts` | Risk and recovery analytics | Application |
| `src/generate-dashboard.ts` | Dashboard rendering | Presentation output |

### Source Adapters

**Purpose**: Integrate external APIs and scraped sources.
**Layer**: Integration
**Entry point**: `src/sources/international/index.ts`

| Directory | Purpose | Layer |
|-----------|---------|-------|
| `src/sources/twelvedata` | Primary XAU/USD feed (API key) | Integration |
| `src/sources/international` | International fallback orchestration | Integration |
| `src/sources/vietnam`, `src/sources/vietnam/history`, `src/sources/vnappmob` | Vietnam current + historical providers | Integration |
| `src/sources/china`, `src/sources/russia`, `src/sources/india` | Regional market adapters | Integration |
| `src/sources/exchange-rate`, `src/sources/premium` | FX conversion and premium logic | Domain service |

### Shared Contracts

**Purpose**: Keep domain shapes and numeric constants consistent.
**Layer**: Shared domain
**Entry point**: `src/types.ts`

| Directory | Purpose | Layer |
|-----------|---------|-------|
| `src/types.ts` | Discriminated result types and market schemas | Shared domain |
| `src/constants.ts` | Ounce/tael conversion + default historical FX | Shared domain |

## Conventions

- Adapter modules expose `fetchAll()` or `fetchCurrent/fetchHistory` returning `FetchResult<T>`.
- Pipeline scripts are executable CLI files with `main().catch(...)` or `import.meta.main` blocks.
- Artifacts are file-based outputs under `data/`, enabling deterministic downstream rendering.
- Runtime configuration is env-driven for API keys, with explicit optional fallbacks.

## Gotchas

- Tree-sitter analyzer produced an empty result for this run; dependency metrics were derived by regex fallback.
- Scraping-heavy adapters (`vietnam`, `india`, `premium`) rely on fragile HTML structure and regex parsing.
- Historical premium calculations can be approximate because backfill uses a fixed exchange rate unless overridden.
- `generate-dashboard.ts` is large and monolithic; UI and calculation logic are interleaved.

## Navigation Guide

- Add or change a data source: `src/sources/*` plus caller in `src/fetch-all.ts`.
- Change normalization or premium logic: `src/fetch-all.ts`, `src/sources/premium/index.ts`, `src/constants.ts`.
- Change historical behavior: `src/fetch-history.ts`, `src/fetch-long-history.ts`, `src/backfill-vietnam.ts`.
- Change dashboard visuals: `src/generate-dashboard.ts` and confirm `data/dashboard.html` output.
- Change automation schedule/deploy: `.github/workflows/collect-daily.yml` and `.github/workflows/backfill.yml`.

## Confidence Assessment

Overall: ▓▓▓▓░ 84%

**High confidence:**
- CLI workflow structure and execution order — directly observed from entry scripts and workflow YAML.
- Hub and dependency center of gravity (`types.ts`, `constants.ts`) — confirmed by import counting.

**Lower confidence:**
- Tree-sitter structural metrics — parser output was empty in this environment.
- Scraped-source behavioral stability — depends on third-party site layout consistency over time.

## △ Caveats

- Assumption: Regex-derived dependency graph accurately reflects local imports; dynamic imports were not observed but would be undercounted.
- Gap: No automated tests were present to validate behavior assertions, so flow confidence relies on static code inspection.
